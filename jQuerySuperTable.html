<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
 <title>jQuery Super Table</title>
 <link rel="stylesheet" type="text/css" href="css/screen.css" />
 <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
 <!--[if IE]>
   <link rel="stylesheet" href="css/ie.css" type="text/css" media="screen, projection" />
 <![endif]-->
</head>
<body>
<div id="container" class="container">
 <div id="content">
   <form action="/performAction.do" method="POST">
     <h2>jQuery Super Table</h2>
     <div id="divv" class="overflowed tall-10">
       <table id="items" class="editable">
         <thead>
         <tr>
           <th class="smallheader"></th>
           <th class="header">Header Data 1</th>
           <th class="header">Header Data 2</th>
           <th class="header">Header Data 3</th>
         </tr>
         <tr>
           <th></th>
           <th>
             <input type="hidden" class="searchby" value="data1" />
             <input type="text" class="livesearch" />
             <a href="#" class="clear prepend-light-1">clear</a>
           </th>
           <th>
             <input type="hidden" class="searchby" value="data2" />
             <input type="text" class="livesearch" />
             <a href="#" class="clear prepend-light-1">clear</a>
           </th>
           <th>
             <input type="hidden" class="searchby" value="data3" />
             <input type="text" class="livesearch" />
             <a href="#" class="clear prepend-light-1">clear</a>
           </th>
         </tr>
         </thead>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="1" />
             <input type="hidden" name="key" value="a something" />
           </td>
           <td class="data1">data 1 row 1</td>
           <td class="data2">data 2 row 1</td>
           <td class="data3">data 3 row 1</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="2" />
             <input type="hidden" name="key" value="not a something" />
           </td>
           <td class="data1">data 1 row 2</td>
           <td class="data2">data 2 row 2</td>
           <td class="data3">data 3 row 2</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="1" />
             <input type="hidden" name="key" value="a something" />
           </td>
           <td class="data1">data 1 row 3</td>
           <td class="data2">data 2 row 3</td>
           <td class="data3">data 3 row 3</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="2" />
             <input type="hidden" name="key" value="not a something" />
           </td>
           <td class="data1">data 1 row 4</td>
           <td class="data2">data 2 row 4</td>
           <td class="data3">data 3 row 4</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="1" />
             <input type="hidden" name="key" value="a something" />
           </td>
           <td class="data1">data 1 row 5</td>
           <td class="data2">data 2 row 5</td>
           <td class="data3">data 3 row 5</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="2" />
             <input type="hidden" name="key" value="not a something" />
           </td>
           <td class="data1">data 1 row 6</td>
           <td class="data2">data 2 row 6</td>
           <td class="data3">data 3 row 6</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="1" />
             <input type="hidden" name="key" value="a something" />
           </td>
           <td class="data1">data 1 row 7</td>
           <td class="data2">data 2 row 7</td>
           <td class="data3">data 3 row 7</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="2" />
             <input type="hidden" name="key" value="not a something" />
           </td>
           <td class="data1">data 1 row 8</td>
           <td class="data2">data 2 row 8</td>
           <td class="data3">data 3 row 8</td>
         </tr>
         <tr class="row editable">
           <td class="nonedit">
             <input type="checkbox" />
             <input type="hidden" name="id" value="1" />
             <input type="hidden" name="key" value="a something" />
           </td>
           <td class="data1">data 1 row 9</td>
           <td class="data2">data 2 row 9</td>
           <td class="data3">data 3 row 9</td>
         </tr>
       </table>
     </div>
   </form>
 </div>
 <hr />
 <div id="footer">
   designed by
   <a href="http://davidwparker.com">David Parker</a>
 </div>
</div>
<script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.7.custom.min.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
$(function(){

//JQuery Extensions
jQuery.fn.extend({
 restoreField: function(val){return this.each(function(){
   $(this).parents(".editing").empty().html(val).removeClass("editing").addClass("edit").end().parents(".popup").remove();
 });},
 moveHeaders: function(){return this.each(function(){
   var $this = $(this), $clone = $this.clone();
   $this.find("thead").remove().end()
     .find("tr:first td").each(function(i){
       var w = $(this).width();
       $clone.find("tr:first th").each(function(j){
         if (i == j){
           $(this).width(w);
         }
       });
     });
   var width = $this.width();
   $clone.addClass("cloned").width(width+2)
     .find("tr.row").remove().end()
     .insertBefore($(".overflowed"));
 });},
 performSearch: function(ajax, selector){return this.each(function(){
   var $this = $(this);
   //every keyup
   $this.keyup(function(){
     doSearch(ajax, selector);
   });
 });}
});

//Functions
function addHover(selector, klass){
 $(selector).hover(function(){
   $(this).addClass(klass);
 },function(){
   $(this).removeClass(klass);
 });
}

function doGetValuesAndSave(j, oldVal){
 var $this = j, $row = $this.parents(".row"),
   val = $this.val(), name = $this.attr("name"),
   action = $this.parents("form").attr("action"),
   id = $row.find("input[name=id]").val(),
   key = $row.find("input[name=key]").val();
 //submit the input's form via ajax here if values are different
 if (oldVal !== val){
   doAjaxSubmit({'action':action,'id':id,'key':key,'name':name,'val':val});
 }
 return val;
}

function doAjaxSubmit(o){
 $.ajax({
   type:"POST",
   url:o.action,
   data:"id="+o.id+"&key="+o.key+"&"+o.name+"="+o.val,
   success: function(data, textStatus){
     alert("Successfully saved with data: \n"+"id="+o.id+"\nkey="+o.key+"\n"+o.name+"="+o.val);
   },
   error: function(xmlHttpRequest, textStatus, errorThrown){
     //alert("Oh no!  Something went wrong!");
     alert("Successfully saved with data: \n"+"id="+o.id+"\nkey="+o.key+"\n"+o.name+"="+o.val);
   }
 });
}

function doSearch(ajax, selector){
 var vals = {};
 //get all the current values and store them by searchby:value
 $(selector).each(function(){
   var $this = $(this), val = $this.val(), searchby = $this.parent().find(".searchby").val();
   vals[searchby] = val;
 });
 if (ajax){

   //ajax will return the latest data from the database and replace our values
   alert('ajax');
 }else{

   //local will not hit the database but just show/hide rows from the current result set
   //reveal all hidden rows, then re-apply the hide
   $(".row").removeClass("hide");
   for (var key in vals){
     var theVal = vals[key];

     $(".row td."+key).each(function(){
       var $this = $(this);
       if (theVal !== "" && ($this.html().search(theVal) === -1)){
         $this.parents(".row").addClass("hide");
       }
     });
   }
 }
}
//Application.js
$("#items tr.editable td:not(.nonedit)").addClass("edit").addClass("fixed");
$("#items tr.editable td.edit").live("click", function(){
 var $this = $(this), oldVal = $this.html(), name = $this.removeClass("edit").removeClass("hovering").attr("class");
 $this.addClass("editing").empty();
 //determine absolute position for popup div and draw it
 var pos = $this.position(), left = pos.left+2, top = pos.top+2,
   popupdiv = "<div class='popup' style='position:absolute;left:"+left+"px;top:"+top+"px;'><input type='text' value='"+oldVal+"' name='"+name+"' /><input type='button' class='push-right-light-1 savebutton' value='Save' /><a href='#' class='cancel push-right-light-1'>cancel</a><input type='hidden' class='oldval' value='"+oldVal+"' /></div>";
 $this.append(popupdiv);
 $(".editing input[type=text]").focus();
});

var $divv = $("#divv");
$divv.scroll(function(){
 if (this.offsetHeight+this.scrollTop+10 >= this.scrollHeight){
   $divv.find("#items").append("<tr class='row editable'><td><input type='checkbox' /></td><td class='edit fixed'>data 1</td><td class='edit fixed'>data 2</td><td class='edit fixed'>data 3</td></tr>");
   addHover(".edit", "hovering");
 }
});

//Click events
$(".clear").live("click", function(){
 $(this).parent().find("input[type='text']").val("");
 doSearch(false, ".livesearch");
 return false;
});

$(".popup a.cancel").live("click", function(){
 var $this = $(this),
   val = $this.parents(".popup").find(".oldval").val();
 $(this).restoreField(val);
 return false;
});

$(".savebutton").live("click", function(){
 var $this = $(this),
   oldVal = $this.parents(".popup").find(".oldval").val(),
   val = doGetValuesAndSave($this.parents(".popup").find("input[type=text]"), oldVal);
 $(this).restoreField(val);
});

//hover
addHover(".edit", "hovering");

//plugins
$("table").moveHeaders();
$(".livesearch").performSearch(false, ".livesearch");

});
/* ]]> */
</script>
</body>
</html>

